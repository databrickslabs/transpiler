; taken from https://github.com/olafhartong/ThreatHunting (MIT License)
[[T1101] Security Support Provider]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 0-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` (event_id=12 OR event_id=13 OR event_id=14) (registry_key_path="*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\process_path File Execution Options\\LSASS.exe") \
| eval mitre_category="Persistence" \
| eval mitre_technique="Security Support Provider" \
| eval mitre_technique_id="T1101" \
| `registry_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description event_type host_fqdn process_path  process_id process_guid registry_key_path registry_key_details mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1070] Indicator Removal on Host]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 1-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="wevtutil.exe" OR process_command_line="*wevtutil* cl*")\
| eval mitre_category="Defense_Evasion" \
| eval mitre_technique="Indicator Removal on Host" \
| eval mitre_technique_id="T1070" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1112] Modify Registry]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 2-15/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="reg.exe" AND process_command_line!="*query*")\
| eval mitre_category="Defense_Evasion" \
| eval mitre_technique="Modify Registry" \
| eval mitre_technique_id="T1112" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1069] Permission Groups Discovery - Network]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 3-15/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` event_id=3 (process_name="net.exe" or process_name="net1.exe")\
| eval mitre_category="Discovery" \
| eval mitre_technique="Permission Groups Discovery" \
| eval mitre_technique_id="T1069" \
| `network_whitelist`\
| eval indextime = _indextime \
| convert ctime(indextime) \
| table _time indextime event_description host_fqdn user_name process_path process_id process_parent_id process_command_line process_guid src_ip dst_ip dst_port src_host_name dst_host_name mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1135] Network Share Discovery - Network]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 4-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` event_id=3 process_name="net.exe" AND (process_command_line="*net* view*" OR process_command_line="*net* share*")\
| eval mitre_category="Discovery" \
| eval mitre_technique="Network Share Discovery" \
| eval mitre_technique_id="T1135" \
| `network_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description host_fqdn user_name process_path process_id process_parent_id process_command_line process_guid src_ip dst_ip dst_port src_host_name dst_host_name mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1018] Remote System Discovery - Process]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 5-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="net.exe" OR process_name="ping.exe") AND (process_command_line="*net* view*" OR process_command_line="*ping *")\
| eval mitre_category="Discovery" \
| eval mitre_technique="Remote System Discovery" \
| eval mitre_technique_id="T1018" \
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1018] Remote System Discovery - Network]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 6-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` event_id=3 (process_name="net.exe" OR process_name="ping.exe")\
| eval mitre_category="Discovery" \
| eval mitre_technique="Remote System Discovery" \
| eval mitre_technique_id="T1018" \
| `network_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description host_fqdn user_name process_path process_id process_parent_id process_command_line process_guid src_ip dst_ip dst_port src_host_name dst_host_name mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1016] System Network Configuration Discovery]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 7-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="net.exe" AND process_command_line="*net* config*") OR (process_name="ipconfig.exe" OR process_name="netsh.exe" OR process_name="arp.exe" OR process_name="nbtstat.exe") \
| eval mitre_category="Discovery" \
| eval mitre_technique="System Network Configuration Discovery" \
| eval mitre_technique_id="T1016" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1076] Remote Desktop Protocol - Process]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 8-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="tscon.exe" OR process_name="mstsc.exe") \
| eval mitre_category="Lateral_Movement" \
| eval mitre_technique="Remote Desktop Protocol" \
| eval mitre_technique_id="T1076" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1076] Remote Desktop Protocol - Network]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 9-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` event_id=3 (process_path="*\\tscon.exe" OR process_name="mstsc.exe") OR dst_port=3389 initiated=true\
| eval mitre_category="Lateral_Movement" \
| eval mitre_technique="Remote Desktop Protocol" \
| eval mitre_technique_id="T1076" \
| `network_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description host_fqdn user_name process_path process_id process_parent_id process_command_line process_guid src_ip dst_ip dst_port src_host_name dst_host_name mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1076] Remote Desktop Protocol - Registry]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 10-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` (event_id=12 OR event_id=13 OR event_id=14) (process_path="C:\\Windows\\system32\\LogonUI.exe" OR registry_key_path="*\\SOFTWARE\\Policies\\Microsoft\\Windows NT\\Terminal Services\\*") \
| eval mitre_category="Lateral_Movement" \
| eval mitre_technique="Remote Desktop Protocol" \
| eval mitre_technique_id="T1076" \
| eval hunting_trigger="RDP logon" \
| `registry_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description event_type host_fqdn process_path  process_id process_guid registry_key_path registry_key_details mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1077] Windows Admin Shares - Network]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 11-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` event_id=3 (process_name="net.exe") AND (process_command_line="*net* use*$" OR process_command_line="*net* session*$" OR process_command_line="*net* file*$")\
| eval mitre_category="Lateral_Movement" \
| eval mitre_technique="Windows Admin Shares" \
| eval mitre_technique_id="T1077" \
| `network_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description host_fqdn user_name process_path process_id process_parent_id process_command_line process_guid src_ip dst_ip dst_port src_host_name dst_host_name mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1047] Windows Management Instrumentation - Process]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 12-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_parent_path="*\\wmiprvse.exe" OR process_name="wmic.exe" OR process_command_line="*wmic* ") \
| eval mitre_category="Execution" \
| eval mitre_technique="Windows Management Instrumentation" \
| eval mitre_technique_id="T1047" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1047] Windows Management Instrumentation - Network]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 13-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` event_id=3 (process_name="wmic.exe" OR process_command_line="*wmic* ")\
| eval mitre_category="Execution" \
| eval mitre_technique="Windows Management Instrumentation" \
| eval mitre_technique_id="T1047" \
| `network_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description host_fqdn user_name process_path process_id process_parent_id process_command_line process_guid src_ip dst_ip dst_port src_host_name dst_host_name mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1047] Windows Management Instrumentation - Instances of an Active Script Event Consumer - Process]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 14-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) process_parent_path="C:\\Windows\\System32\\svchost.exe" AND process_path="C:\\WINDOWS\\system32\\wbem\\scrcons.exe"\
| eval mitre_category="Execution" \
| eval mitre_technique="Windows Management Instrumentation" \
| eval mitre_technique_id="T1047" \
| eval hunting_trigger="Instances of an Active Script Event Consumer" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1047] Windows Management Instrumentation - Instances of an Active Script Event Consumer - FileAccess]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 0-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
search = `indextime` `sysmon` event_id=11 process_path="C:\\WINDOWS\\system32\\wbem\\scrcons.exe"\
| eval mitre_category="Execution" \
| eval mitre_technique="Windows Management Instrumentation" \
| eval mitre_technique_id="T1047" \
| eval hunting_trigger="Instances of an Active Script Event Consumer" \
| `file_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description host_fqdn process_path file_path process_guid process_id mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1201] Password Policy Discovery]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 1-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_command_line="*net* accounts*" OR process_command_line="*net* accounts \/domain*")\
| eval mitre_category="Discovery"\
| eval mitre_technique="Password Policy Discovery"\
| eval mitre_technique_id="T1201" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1209] Time Providers]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 2-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` (event_id=12 OR event_id=13 OR event_id=14) (registry_key_path="*\\System\\CurrentControlSet\\Services\\W32Time\\TimeProviders\\*")\
| eval mitre_category="Discovery"\
| eval mitre_technique="Indirect Command Execution"\
| eval mitre_technique_id="T1209" \
| `registry_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description event_type host_fqdn process_path  process_id process_guid registry_key_path registry_key_details mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1057] Process Discovery]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 3-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) process_name="tasklist.exe" OR process_command_line="*Get-Process*"\
| eval mitre_category="Execution"\
| eval mitre_technique="Process Discovery"\
| eval mitre_technique_id="T1057" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1075] Pass the Hash NULL SID]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 4-59/15 * * * *
description = Windows EventID 4624
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `windows-security` event_id=4624 AND ((Security_ID="NULL SID" OR Security_ID="S-1-0-0") AND (Logon_Type="3") AND (Source_Network_Address != "*::1*") AND (Logon_Process="*NtLmSsp") AND (Package_Name__NTLM_only_="*NTLM V2") AND (Key_Length="0") AND (user != "*ANONYMOUS LOGON" OR Account_Name != "*ANONYMOUS LOGON")) \
| eval hunting_trigger="NULL SID used"\
| eval mitre_category="Lateral_Movement"\
| eval mitre_technique="Pass the Hash"\
| eval mitre_technique_id="T1075"\
| eval target_user_name=mvindex(Account_Name,1) \
| eval user_name=mvindex(Account_Name,0) \
| eval target_user_domain=mvindex(Account_Domain,1) \
| rename ComputerName as host_fqdn, Source_Network_Address as src_ip, Workstation_Name as src_host_name \
| eval indextime = _indextime \
| convert ctime(indextime) \
| table _time indextime,host_fqdn, user_sid, user_name src_host_name src_ip target_user_name target_user_domain mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1086] PowerShell Downloads - WinProcess]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 5-59/15 * * * *
description = Windows Security
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
search = `indextime` `windows-security` event_id=4688 (".Download" OR "Net.WebClient") \
| eval hunting_trigger="Download or web connection" \
| eval mitre_category="Execution" \
| eval mitre_technique="PowerShell" \
| eval mitre_technique_id="T1086" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime, host, host_fqdnName, Account_Name, New_Process_Name, Process_Command_Line| rename Process_Command_Line as process_command_line, New_Process_Name as process_path, Account_Name as user_name mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1187] Forced Authentication]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 6-59/15 * * * *
description = Whitelisting required
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` search `sysmon` event_id=11 (file_path="*.lnk" OR file_path="*.scf")\
| eval mitre_category="Credential_Access"\
| eval mitre_technique="Forced Authentication"\
| eval mitre_technique_id="T1187" \
| `file_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description host_fqdn process_path file_path process_guid process_id mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1214] Credentials in Registry]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 7-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_command_line="*reg* query HKLM \/f password \/t REG_SZ \/s*" OR process_command_line="reg* query HKCU \/f password \/t REG_SZ \/s" OR process_command_line="*Get-UnattendedInstallFile*" OR process_command_line="*Get-Webconfig*" OR process_command_line="*Get-ApplicationHost*" OR process_command_line="*Get-SiteListPassword*" OR process_command_line="*Get-CachedGPPPassword*" OR process_command_line="*Get-RegistryAutoLogon*") \
| eval mitre_category="Credential_Access"\
| eval mitre_technique="Credentials in Registry"\
| eval mitre_technique_id="T1214" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1053] Scheduled Task - Process]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 8-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="taskeng.exe" OR process_name="schtasks.exe" OR process_name="svchost.exe" process_parent_path!="C:\\Windows\\System32\\services.exe") \
| eval mitre_technique_id="T1053" \
| eval mitre_category="Persistence,Privilege_Escalation,Execution"\
| eval mitre_technique="Scheduled Task"\
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1053] Scheduled Task - FileAccess]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 9-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` event_id=11 process_path!="C:\\WINDOWS\\system32\\svchost.exe" (file_path="C:\\Windows\\System32\\Tasks\\*" OR file_path="C:\\Windows\\Tasks\\*") \
| eval mitre_category="Persistence,Privilege_Escalation,Execution"\
| eval mitre_technique="Scheduled Task"\
| eval mitre_technique_id="T1053" \
| `file_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description host_fqdn process_path file_path process_guid process_id mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1013] Local Port Monitor]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 10-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` (event_id=12 OR event_id=13 OR event_id=14) (registry_key_path="*\\SYSTEM\CurrentControlSet\Control\Print\Monitors\\*") \
| eval mitre_category="Persistence,Privilege_Escalation"\
| eval mitre_technique="Local Port Monitor"\
| eval mitre_technique_id="T1013" \
| `registry_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description event_type host_fqdn process_path  process_id process_guid registry_key_path registry_key_details mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1015] Accessibility Features]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 11-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` event_id=1 process_parent_name="winlogon.exe" (process_name="sethc.exe" OR process_name="utilman.exe" OR process_name="osk.exe" OR process_name="magnify.exe" OR process_name="displayswitch.exe" OR process_name="narrator.exe" OR process_name="atbroker.exe") \
| eval mitre_category="Persistence,Privilege_Escalation"\
| eval mitre_technique="Accessibility Features"\
| eval mitre_technique_id="T1015" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1085] Rundll32]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 12-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_parent_path="*\\rundll32.exe" OR process_name="rundll32.exe") \
| eval mitre_category="Defense_Evasion,Execution"\
| eval mitre_technique="Rundll32"\
| eval mitre_technique_id="T1085" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1088] Bypass User Account Control - Process]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 13-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_parent_path="*\\eventvwr.exe" OR process_parent_path="*\\fodhelper.exe") \
| eval mitre_category="Privilege_Escalation,Defense_Evasion"\
| eval mitre_technique="Bypass User Account Control"\
| eval mitre_technique_id="T1088" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1103] AppInit DLLs]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 14-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` (event_id=12 OR event_id=13 OR event_id=14) (registry_key_path="*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Windows\\Appinit_Dlls\\*" OR registry_key_path="*\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows NT\\CurrentVersion\\Windows\\Appinit_Dlls\\*") \
| eval mitre_category="Persistence,Privilege_Escalation"\
| eval mitre_technique="AppInit DLLs"\
| eval mitre_technique_id="T1103" \
| `registry_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description event_type host_fqdn process_path  process_id process_guid registry_key_path registry_key_details mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1117] Regsvr32 - Network]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 1-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` event_id=3 (process_parent_path="*\\regsvr32.exe" OR process_path="*\\regsvr32.exe") \
| eval mitre_category="Defense_Evasion,Execution"\
| eval mitre_technique="Regsvr32"\
| eval mitre_technique_id="T1117" \
| `network_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description host_fqdn user_name process_path process_id process_parent_id process_command_line process_guid src_ip dst_ip dst_port src_host_name dst_host_name mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1118] InstallUtil]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 2-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="InstallUtil.exe" OR process_command_line="*\/logfile= \/LogToConsole=false \/U*")\
| eval mitre_category="Defense_Evasion,Execution"\
| eval mitre_technique="InstallUtil"\
| eval mitre_technique_id="T1118" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1121] Regsvcs/Regasm]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 3-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="regsvcs.exe" OR process_name="regasm.exe")\
| eval mitre_category="Defense_Evasion,Execution"\
| eval mitre_technique="Regsvcs/Regasm"\
| eval mitre_technique_id="T1121" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1122] Component Object Model Hijacking]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 4-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` (event_id=12 OR event_id=13 OR event_id=14) (registry_key_path="*\\Software\\Classes\\CLSID\\*") \
| eval mitre_category="Persistence,Defense_Evasion"\
| eval mitre_technique="Component Object Model Hijacking"\
| eval mitre_technique_id="T1122" \
| `registry_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description event_type host_fqdn process_path  process_id process_guid registry_key_path registry_key_details mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1138] Application Shimming - Process]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 5-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) process_name="sdbinst.exe" \
| eval mitre_category="Persistence,Privilege_Escalation"\
| eval mitre_technique="Application Shimming"\
| eval mitre_technique_id="T1138" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1138] Application Shimming - FileAccess]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 6-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` event_id=11 (file_path="C:\\Windows\\AppPatch\\Custom\\*") \
| eval mitre_category="Persistence,Privilege_Escalation"\
| eval mitre_technique="Application Shimming"\
| eval mitre_technique_id="T1138" \
| `file_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description host_fqdn process_path file_path process_guid process_id mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1138] Application Shimming - Registry]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 7-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` (event_id=12 OR event_id=13 OR event_id=14) (registry_key_path="*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\AppCompatFlags\\InstalledSDB\\*") \
| eval mitre_category="Persistence,Privilege_Escalation"\
| eval mitre_technique="Application Shimming"\
| eval mitre_technique_id="T1138" \
| `registry_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description event_type host_fqdn process_path  process_id process_guid registry_key_path registry_key_details mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1182] AppCert DLLs]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 8-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` (event_id=12 OR event_id=13 OR event_id=14) (registry_key_path="*\\System\\CurrentControlSet\\Control\\Session Manager\\AppCertDlls\\*")\
| eval mitre_category="Persistence,Privilege_Escalation"\
| eval mitre_technique="AppCert DLLs"\
| eval mitre_technique_id="T1182" \
| `registry_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description event_type host_fqdn process_path  process_id process_guid registry_key_path registry_key_details mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1191] CMSTP]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 9-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="CMSTP.exe")\
| eval mitre_category="Defense_Evasion,Execution"\
| eval mitre_technique="CMSTP"\| eval mitre_technique_id="T1191" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1196] Control Panel Items - Process]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 10-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_command_line="*control* \/name*" OR process_command_line="rundll32* shell32.dll,Control_RunDLL") \
| eval mitre_category="Defense_Evasion,Execution"\
| eval mitre_technique="Control Panel Items"\
| eval mitre_technique_id="T1196" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1196] Control Panel Items - Registry]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 11-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` (event_id=12 OR event_id=13 OR event_id=14) (registry_key_path="*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\ControlPanel\\NameSpace*" OR registry_key_path="*\\Software\\Microsoft\\Windows\\CurrentVersion\\Controls Folder\\*\\Shellex\\PropertySheetHandlers\\*" OR registry_key_path="*\\Software\\Microsoft\\Windows\\CurrentVersion\\Control Panel\\*") \
| eval mitre_category="Defense_Evasion,Execution"\
| eval mitre_technique="Control Panel Items"\
| eval mitre_technique_id="T1196" \
| `registry_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description event_type host_fqdn process_path  process_id process_guid registry_key_path registry_key_details mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1216] Signed Script Proxy Execution]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 12-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_command_line="*cscript*script\:http\[\:\]\/\/*" OR process_command_line="*wscript*script\:http\[\:\]\/\/*" OR process_command_line="*certutil*script\:http\[\:\]\/\/*" OR process_command_line="*jjs*-scripting*")\
| eval mitre_category="Defense_Evasion,Execution"\
| eval mitre_technique="Signed Script Proxy Execution"\
| eval mitre_technique_id="T1216" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1218] Signed Binary Proxy Execution - Process]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 12-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_command_line="*mavinject*\/injectrunning*" OR process_command_line="mavinject32*\/injectrunning*" OR process_command_line="*certutil*script\:http\[\:\]\/\/*" OR process_command_line="*certutil*script\:https\[\:\]\/\/*" OR process_command_line="*msiexec*http\[\:\]\/\/*" OR process_command_line="*msiexec*https\[\:\]\/\/*")\
| eval mitre_category="Defense_Evasion,Execution"\
| eval mitre_technique="Signed Binary Proxy Execution"\
| eval mitre_technique_id="T1218" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1218] Signed Binary Proxy Execution - Network]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 13-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` event_id=3 (process_name=certutil.exe OR process_command_line="*certutil*script\:http\[\:\]\/\/*" OR process_path="*\\replace.exe")\
| eval mitre_category="Defense_Evasion,Execution"\
| eval mitre_technique="Signed Binary Proxy Execution"\
| eval mitre_technique_id="T1218" \
| `network_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description host_fqdn user_name process_path process_id process_parent_id process_command_line process_guid src_ip dst_ip dst_port src_host_name dst_host_name mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1197] BITS Jobs - Network]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 14-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` event_id=3 (process_name="bitsadmin.exe")\
| eval mitre_category="Persistence,Defense_Evasion"\
| eval mitre_technique="BITS Jobs"\
| eval mitre_technique_id="T1197" \
| `network_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description host_fqdn user_name process_path process_id process_parent_id process_command_line process_guid src_ip dst_ip dst_port src_host_name dst_host_name mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1054] Indicator Blocking - Unknown Sysmon Config loaded]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 0-59/15 * * * *
description = Make sure to keep trusted-sysmon-configurations.csv up to date
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` event_id=16 NOT [|inputlookup trusted-sysmon-configurations.csv | fields hash_sha1]\
| eval hunting_trigger="Unknown Sysmon Config loaded"\
| eval mitre_category="Defense_Evasion"\
| eval mitre_technique="Indicator Blocking"\
| eval mitre_technique_id = "T1054"\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime host_fqdn sysmon_configuration hash_sha1  mitre_category mitre_technique mitre_technique_id hunting_trigger\
| rename hash_sha1 as "Unknown HASH"\
| collect `threathunting_index`

[[T1089] Disabling Security Tools - Sysmon service state change]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 1-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = | multisearch [search `indextime` `sysmon` event_id=4 State!=Started | fields _time host_fqdn service_state] [search `indextime` `windows-security` event_id=7036 Message="*Sysmon*" \
| eval hunting_trigger="Sysmon state change"\
| eval mitre_category="Defense_Evasion"\
| eval mitre_technique="Disabling Security Tools"\
| eval mitre_technique_id = "T1089"\
| rename HostName as host_fqdn Message as service_state | fields host_fqdn service_state] | eval indextime = _indextime | convert ctime(indextime) | table _time indextime host_fqdn service_state mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T0000] Connections from Uncommon Locations]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 2-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` event_id=3 (process_path="C:\\user_names\\*" OR process_path="C:\\ProgramData\\*" OR process_path="C:\\Windows\\Temp\\*" OR process_path="C:\\Temp\\*") initiated=true \
| eval mitre_category="Lateral_Movement,Execution"\
| eval mitre_technique="Connections from Uncommon Locations"\
| eval mitre_technique_id="T0000" \
| `network_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description host_fqdn user_name process_path process_id process_guid src_ip dst_ip dst_port src_host_name dst_host_name initiated transport mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T0000] Remotely Query Login Sessions - Process]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 3-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="qwinsta.exe")\
| eval mitre_category="Discovery"\
| eval mitre_technique="Remotely Query Login Sessions"\
| eval mitre_technique_id="T0000" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T0000] Remotely Query Login Sessions - Network]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 4-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` event_id=3 (process_name="qwinsta.exe")\
| eval mitre_category="Discovery"\
| eval mitre_technique="Remotely Query Login Sessions"\
| eval mitre_technique_id="T0000" \
| `network_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description host_fqdn user_name process_path process_id process_guid src_ip dst_ip dst_port src_host_name dst_host_name initiated transport mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1043] Commonly Used Port]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 5-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` event_id=3 (dst_port="22" OR dst_port="23" OR dst_port="25" OR dst_port="135" OR dst_port="3389" OR dst_port="5800" OR dst_port="5900" OR dst_port="8080") initiated=true\
| eval mitre_category="Command_and_Control"\
| eval mitre_technique="Commonly Used Port"\
| eval mitre_technique_id="T1043" \
| `network_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description host_fqdn user_name process_path process_id process_guid src_ip dst_ip dst_port src_host_name dst_host_name initiated transport mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1131] Authentication Package]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 6-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` (event_id=12 OR event_id=13 OR event_id=14)  (registry_key_path="*\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\*") AND NOT (process_path="C:\\WINDOWS\\system32\\lsass.exe" OR process_path="C:\\Windows\\system32\\svchost.exe" OR process_path="C:\\Windows\\system32\\services.exe")\
| eval mitre_category="Persistence"\
| eval mitre_technique="Authentication Package"\
| eval mitre_technique_id="T1131" \
| `registry_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description event_type host_fqdn process_path  process_id process_guid registry_key_path registry_key_details mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1003] Credential Dumping - Process Access]
action.email.useNSSubject = 1
action.threat_add.param.verbose = 0
alert.track = 0
cron_schedule = 7-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` (event_id=10) (target_process_path="C:\\Windows\\system32\\lsass.exe") AND (process_granted_access=0x1010 OR process_granted_access=0x1410 OR process_granted_access=0x147a OR process_granted_access=0x143a) process_call_trace="C:\\Windows\\SYSTEM32\\ntdll.dll\*|C:\\Windows\\system32\\KERNELBASE.dll*|UNKNOWN(*)"\
| eval hunting_trigger="Potentially Mimikatz"\
| eval mitre_category="Credential_Access"\
| eval mitre_technique="Credential Dumping"\
| eval mitre_technique_id="T1003" \
| `process_access_whitelist` \
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description host_fqdn process_path target_process_path process_granted_access process_guid target_process_guid process_id target_process_id process_granted_access_description mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1003] Credential Dumping - Registry]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 8-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` (event_id=12 OR event_id=13 OR event_id=14) process_path!="C:\\WINDOWS\\system32\\lsass.exe"  (registry_key_path="*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Authentication\\Credential Provider\\*" OR registry_key_path="*\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\*" OR registry_key_path="*\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SecurityProviders\\*" OR registry_key_path="*\\Control\\SecurityProviders\\WDigest\\*") NOT registry_key_path="*\\Lsa\\RestrictRemoteSamEventThrottlingWindow NOT registry_key_path="*\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\nolmhash" \
| eval mitre_category="Credential_Access"\
| eval mitre_technique="Credential Dumping"\
| eval mitre_technique_id="T1003" \
| `registry_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description event_type host_fqdn process_path  process_id process_guid registry_key_path registry_key_details mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1059] Command-Line Interface]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 9-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="cmd.exe") \
| eval mitre_category="Execution"\
| eval mitre_technique="Command-Line Interface"\
| eval mitre_technique_id="T1059" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1128] Netsh Helper DLL - Registry]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 10-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` (event_id=12 OR event_id=13 OR event_id=14) (registry_key_path="*\\SOFTWARE\Microsoft\Netsh\\*") \
| eval mitre_category="Persistence"\
| eval mitre_technique="Netsh Helper DLL"\
| eval mitre_technique_id="T1128" \
| `registry_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description event_type host_fqdn process_path  process_id process_guid registry_key_path registry_key_details mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1004] Winlogon Helper DLL]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 11-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` (event_id=12 OR event_id=13 OR event_id=14) (registry_key_path="*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\user_nameinit\\*" OR registry_key_path="*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Shell\\*" OR registry_key_path="*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Notify\\*") \
| eval mitre_category="Persistence"\
| eval mitre_technique="Winlogon Helper DLL"\
| eval mitre_technique_id="T1004" \
| `registry_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description event_type host_fqdn process_path  process_id process_guid registry_key_path registry_key_details  mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1012] Query Registry - Network]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 12-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` event_id=3 (process_name="reg.exe" AND process_command_line="*reg* query*") \
| eval mitre_category="Discovery"\
| eval mitre_technique="Query Registry"\
| eval mitre_technique_id="T1012" \
| `network_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description host_fqdn user_name process_path process_id process_parent_id process_command_line process_guid src_ip dst_ip dst_port src_host_name dst_host_name mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1012] Query Registry - Process]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 13-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="reg.exe" AND process_command_line="*reg* query*") \
| eval mitre_category="Discovery"\
| eval mitre_technique="Query Registry"\
| eval mitre_technique_id="T1012" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1047] WMI command execution]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 14-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
search = `indextime` `sysmon` event_id=20 wmi_consumer_type="Command Line" \
| eval hunting_trigger="WMI command execution \
| eval mitre_category="Lateral_Movement"\
| eval mitre_technique="Windows_Management_Instrumentation"\
| eval mitre_technique_id = "T1047" \
| eval hash_sha256= lower(hash_sha256)\
| `wmi_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description host_fqdn user_name wmi_consumer_name wmi_consumer_destination mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1170] MSHTA - Process]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 0-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_parent_path="*\\mshta.exe" OR process_name="mshta.exe") \
| eval mitre_category="Defense_Evasion,Execution"\
| eval mitre_technique="MSHTA"\
| eval mitre_technique_id="T1047" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1170] MSHTA - Network]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 1-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` event_id=3 (process_parent_path="*\\mshta.exe" OR process_path="*\\mshta.exe") \
| eval mitre_category="Defense_Evasion,Execution"\
| eval mitre_technique="MSHTA"\
| eval mitre_technique_id="T1047" \
| `network_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description host_fqdn user_name process_path process_id process_parent_id process_command_line process_guid src_ip dst_ip dst_port src_host_name dst_host_name mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1170] MSHTA - FileAccess]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 2-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` (event_id=11 or event_id=15) (file_path="*.hta") \
| eval mitre_category="Defense_Evasion,Execution"\
| eval mitre_technique="MSHTA"\
| eval mitre_technique_id="T1170" \
| `file_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description host_fqdn process_path file_path process_guid process_id mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1089] Disabling Security Tools - Sysmon service was terminated]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 3-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `windows-security` EventCode=7034 Message="*Sysmon*"\
| eval hunting_trigger="Sysmon service was terminated"\
| eval mitre_category="Defense_Evasion"\
| eval mitre_technique="Disabling Security Tools"\
| eval mitre_technique_id="T1089" \
| rename ComputerName as Computer Message as State \
| eval indextime = _indextime | convert ctime(indextime) | table Computer State mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1054] Indicator Blocking - Sysmon registry edited from other source]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 4-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` (event_id=12 OR event_id=13 OR event_id=14) (registry_key_path="HKLM\\System\\CurrentControlSet\\Services\\SysmonDrv\\*" OR registry_key_path="HKLM\\System\\CurrentControlSet\\Services\\Sysmon\\*" OR registry_key_path="HKLM\\System\\CurrentControlSet\\Services\\Sysmon64\\*") process_name!="Sysmon64.exe" process_name!="Sysmon.exe" \
| eval hunting_trigger="Sysmon registry edited from other source"\
| eval mitre_category="Defense_Evasion"\
| eval mitre_technique="Indicator Blocking"\
| eval mitre_technique_id="T1054" \
| `registry_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description event_type host_fqdn process_path  process_id process_guid registry_key_path registry_key_details mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1003] Credential Dumping ImageLoad]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 5-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` event_id=7 (driver_loaded="C:\\Windows\\System32\\samlib.dll" OR driver_loaded="C:\\Windows\\System32\\WinSCard.dll" OR driver_loaded="C:\\Windows\\System32\\cryptdll.dll" OR driver_loaded="C:\\Windows\\System32\\hid.dll" OR driver_loaded="C:\\Windows\\System32\\vaultcli.dll") (process_path!="*\\Sysmon.exe" process_path!="*\\svchost.exe" process_path!="*\\logonui.exe")\
    | transaction process_guid maxspan=5s\
    | eval keep = mvcount(driver_loaded)\
    | search keep > 3\
    | eval hunting_trigger="Probably Mimikatz"\
    | eval mitre_category="Credential_Access"\
    | eval mitre_technique="Credential Dumping"\
    | eval mitre_technique_id="T1003" \
    | `image_load_whitelist`\
    | eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description host_fqdn process_path driver_loaded driver_is_signed driver_signature driver_signature_status process_id process_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1086] PowerShell Downloads - Process]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 6-59/15 * * * *
description = Sysmon
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_command_line="*.Download*" OR process_command_line="*Net.WebClient*") \
| eval hunting_trigger="Download or web connection"\
| eval mitre_category="Execution"\
| eval mitre_technique="PowerShell"\
| eval mitre_technique_id="T1086" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1054] Indicator Blocking - Driver unloaded]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 7-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="fltmc.exe" OR process_command_line="*fltmc*unload*")\
| eval hunting_trigger="Unknown Sysmon Config loaded"\
| eval mitre_category="Defense_Evasion"\
| eval mitre_technique="Indicator Blocking"\
| eval mitre_technique_id="T1054" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1208] Kerberoasting]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 8-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `windows-security` EventCode=4769 Ticket_Encryption_Type=0x17  Service_ID!=NONE_MAPPED Account_Name!="sa_*"\
| transaction Account_Name maxpause=60s maxevents=500\
| where eventcount>10\
|where Service_ID>1\
| eval mitre_category="Credential_Access"\
| eval mitre_technique="Kerberoasting"\
| eval mitre_technique_id = "T1208"\
| eval indextime = _indextime | convert ctime(indextime) | table  Account_Name Service_ID eventcount mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1097] Pass the ticket]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 9-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `windows-security` (EventCode=4771 OR EventCode=4768 OR EventCode=4769) Failure_Code=0x1F\
| eval mitre_category="Lateral_Movement"\
| eval mitre_technique="Pass_the_Ticket"\
| eval mitre_technique_id = "T1097"\
| collect `threathunting_index`

[[T1089] Disabling Security Tools - Service stopped]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 10-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name=net.exe OR process_name=sc.exe) cmdline="* stop *"\
| eval hash_sha256= lower(hash_sha256)\
| eval hunting_trigger="Service stopped"\
| eval mitre_category="Defense_Evasion"\
| eval mitre_technique="Disabling Security Tools"\
| eval mitre_technique_id = "T1089"\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1003] Credential Dumping - Registry Save]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 11-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) process_name=reg.exe (process_command_line="*save*HKLM\\sam*" OR process_command_line="*save*HKLM\\system*") \
| eval hunting_trigger="Reg dump SAM/System db"\
| eval mitre_category="Credential_Access"\
| eval mitre_technique="Credential Dumping"\
| eval mitre_technique_id="T1003" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1077] Windows Admin Shares - Process - Created]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 12-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="net.exe") AND (process_command_line="*net* share*$")\
| eval hunting_trigger="Share creation"\
| eval mitre_category="Lateral_Movement"\
| eval mitre_technique="Windows Admin Shares"\
| eval mitre_technique_id="T1077" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1096] NTFS File Attributes]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 13-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) process_name="fsutil.exe" proces_command_line="*usn*deletejournal*" \
| eval hunting_trigger="MFT/USN modification"\
| eval mitre_category="Defense_Evasion"\
| eval mitre_technique="NTFS_File_Attributes"\
| eval mitre_technique_id="T1096" \
| eval hash_sha256= lower(hash_sha256) \
| `process_create_whitelist` \
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1084] Windows Management Instrumentation Event Subscription]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 14-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` event_id=21 \
| eval mitre_category="Execution"\
| eval mitre_technique="Windows Management Instrumentation Event Subscription"\
| eval mitre_technique_id="T1084" \
| `wmi_whitelist` \
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime host_fqdn user_name wmi_consumer_name wmi_consumer_destination mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1003] Credential Dumping - Process]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 0-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) process_command_line="*Invoke-Mimikatz -DumpCreds*" OR process_command_line="gsecdump* -a" OR process_command_line="wce* -o" OR process_command_line="procdump* -ma lsass.exe*" OR process_command_line="ntdsutil*ac i ntds*ifm*create full"\
| eval mitre_category="Credential_Access"\
| eval mitre_technique="Credential Dumping"\
| eval mitre_technique_id="T1003" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1007] System Service Discovery]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 1-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="net.exe" OR process_name="tasklist.exe" OR process_name="sc.exe" OR process_name="wmic.exe") AND (process_command_line="*net* start*" OR process_command_line="*tasklist \/svc*" OR process_command_line="*sc* query*" OR process_command_line="wmic* service where*") \
| eval mitre_category="Discovery"\
| eval mitre_technique="System Service Discovery"\
| eval mitre_technique_id="T1007" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1015] Accessibility Features - Registry]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 2-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` (event_id=12 OR event_id=13 OR event_id=14) (registry_key_path="HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\*")\
| eval mitre_category="Persistence,Privilege_Escalation"\
| eval mitre_technique="Accessibility Features"\
| eval mitre_technique_id="T1015" \
| `registry_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description event_type host_fqdn process_path  process_id process_guid registry_key_path registry_key_details mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1033] System Owner/User Discovery]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 3-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="whoami.exe" OR process_command_line="*whoami*" OR process_command_line="wmic* useraccount get /ALL" OR process_name="qwinsta.exe" OR process_name="quser.exe")\
| eval mitre_category="Discovery"\
| eval mitre_technique="System Owner/User Discovery"\
| eval mitre_technique_id="T1033" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1049] System Network Connections Discovery]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 4-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="net.exe" OR process_name="netstat.exe") AND (process_command_line="*net* use*" OR process_command_line="*net* sessions*" OR process_command_line="*net* file*" OR process_command_line="*netstat*") OR process_command_line="*Get-NetTCPConnection*"\
| eval mitre_category="Discovery"\
| eval mitre_technique="System Network Connections Discovery"\
| eval mitre_technique_id="T1049" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1060] Registry Run Keys or Start Folder]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 5-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` (event_id=12 OR event_id=13 OR event_id=14) (registry_key_path="*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run*" OR registry_key_path="*\\Software\\Microsoft\\Windows\\CurrentVersion\Explorer\\*Shell Folders") \
| eval mitre_category="Persistence"\
| eval mitre_technique="Registry Run Keys or Start Folder"\
| eval mitre_technique_id="T1060" \
| `registry_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description event_type host_fqdn process_path  process_id process_guid registry_key_path registry_key_details mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1086] PowerShell]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 6-59/15 * * * *
description = Sysmon
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="powershell.exe" OR process_name="powershell_ise.exe" OR process_name="psexec.exe") \
| eval mitre_category="Execution"\
| eval mitre_technique="PowerShell"\
| eval mitre_technique_id="T1086" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1063] Security Software Discovery]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 7-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="netsh.exe" OR process_name="reg.exe" OR process_name="tasklist.exe") AND (process_command_line="*reg* query*" OR process_command_line="*tasklist *" OR process_command_line="*netsh*" OR process_command_line="*fltmc*|*findstr*")\
| eval mitre_category="Discovery"\
| eval mitre_technique="Security Software Discovery"\
| eval mitre_technique_id="T1063" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1069] Permission Groups Discovery - Process]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 8-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) process_name="net.exe" AND (process_command_line="*net* user*" OR process_command_line="*net* group*" OR process_command_line="*net* localgroup*" OR process_command_line="*get-localgroup*" OR process_command_line="*get-ADPrinicipalGroupMembership*")\
| eval mitre_category="Discovery"\
| eval mitre_technique="Permission Groups Discovery"\
| eval mitre_technique_id="T1069" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1074] Data Staged - Process]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 9-59/15 * * * *
description = Sysmon
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_command_line="*DownloadString*" AND process_command_line="*Net.WebClient*" process_command_line="*New-Object*" AND process_command_line="*IEX*") \
| eval mitre_category="Collection"\
| eval mitre_technique="Data Staged"\
| eval mitre_technique_id="T1074" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1077] Windows Admin Shares - Process]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 10-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="net.exe" OR process_name=powershell.exe) AND (process_command_line="*net* use*$" OR process_command_line="*net* session*$" OR process_command_line="*net* file*$" process_command_line=""*New-PSDrive*root*)\
| eval mitre_category="Lateral_Movement"\
| eval mitre_technique="Windows Admin Shares"\
| eval mitre_technique_id="T1077" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1081] Credentials in Files]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 11-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_command_line="*findstr* /si pass*" OR process_command_line="*select-string -Pattern pass*" OR process_command_line="*list vdir*/text:password*") \
| eval mitre_category="Credential_Access"\
| eval mitre_technique="Credentials in Files"\
| eval mitre_technique_id="T1081" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1082] System Information Discovery]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 12-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="sysinfo.exe") OR (process_name="reg.exe" AND process_command_line="reg*query HKLM\\SYSTEM\\CurrentControlSet\\Services\\Disk\\Enum")\
| eval mitre_category="Discovery"\
| eval mitre_technique="System Information Discovery"\
| eval mitre_technique_id="T1082" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1087] Account Discovery]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 13-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="net.exe" OR process_name="powershell.exe") AND (process_command_line="*net* user*" OR process_command_line="*net* group*" OR process_command_line="*net* localgroup*" OR process_command_line="cmdkey*\/list*" process_command_line="*get-localuser*" OR process_command_line="*get-localgroupmembers*" OR process_command_line="*get-aduser*" OR process_command_line="query*user*")\
| eval mitre_category="Discovery"\
| eval mitre_technique="Account Discovery"\
| eval mitre_technique_id="T1087" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1107] File Deletion]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 14-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_command_line="*remove-item*" OR process_command_line="vssadmin*Delete Shadows /All /Q*" OR process_command_line="*wmic*shadowcopy delete*" OR process_command_line="*wbdadmin* delete catalog -q*" OR process_command_line="*bcdedit*bootstatuspolicy ignoreallfailures*" OR process_command_line="*bcdedit*recoveryenabled no*")\
| eval mitre_category="Defense_Evasion"\
| eval mitre_technique="File Deletion"\
| eval mitre_technique_id="T1107" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1115] Clipboard Data]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 0-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="clip.exe" OR process_command_line="*Get-Clipboard*")\
| eval mitre_category="Collection"\
| eval mitre_technique="Clipboard Data"\
| eval mitre_technique_id="T1115" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1123] Audio Capture]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 1-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="SoundRecorder.exe" OR process_command_line="*Get-AudioDevice*" OR process_command_line="*WindowsAudioDevice-Powershell-Cmdlet*")\
| eval mitre_category="Collection"\
| eval mitre_technique="Audio Capture"\
| eval mitre_technique_id="T1123" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1124] System Time Discovery]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 2-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_path="*\\net.exe" AND process_command_line="*net* time*") OR process_name="w32tm.exe" OR process_command_line="*Get-Date*"\
| eval mitre_category="Discovery"\
| eval mitre_technique="System Time Discovery"\
| eval mitre_technique_id="T1124" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1126] Network Share Connection Removal]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 3-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="net.exe" AND process_command_line="*net* delete*") OR process_command_line="*Remove-SmbShare*" OR process_command_line="*Remove-FileShare*"\
| eval hunting_trigger="Share removal"\
| eval mitre_category="Defense_Evasion"\
| eval mitre_technique="Network Share Connection Removal"\
| eval mitre_technique_id="T1126" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1127] Trusted Developer Utilities]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 4-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="MSBuild.exe" OR process_name="msxsl.exe") \
| eval mitre_category="Defense_Evasion,Execution"\
| eval mitre_technique="Trusted Developer Utilities"\
| eval mitre_technique_id="T1127" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1128] Netsh Helper DLL - Process]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 5-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="netsh.exe" AND process_command_line="*helper*")\
| eval mitre_category="Persistence"\
| eval mitre_technique="Netsh Helper DLL"\
| eval mitre_technique_id="T1128" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1130] Install Root Certificate]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 6-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` (event_id=12 OR event_id=13 OR event_id=14) process_name!="svchost.exe" AND (registry_key_path="*\\SOFTWARE\\Microsoft\\EnterpriseCertificates\\Root\\Certificates\\*" OR registry_key_path="*\\Microsoft\\SystemCertificates\\Root\\Certificates\\*")\
| eval mitre_category="Defense_Evasion"\
| eval mitre_technique="Install Root Certificate"\
| eval mitre_technique_id="T1130" \
| `registry_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description event_type host_fqdn process_path  process_id process_guid registry_key_path registry_key_details mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1135] Network Share Discovery - Process]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 7-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="net.exe" AND (process_command_line="*net* view*" OR process_command_line="*net* share*")) OR process_command_line="*get-smbshare -Name*"\
| eval mitre_category="Discovery"\
| eval mitre_technique="Network Share Discovery"\
| eval mitre_technique_id="T1135" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1136] Create Account]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 8-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_command_line="*New-LocalUser*" OR process_command_line="*net*user*add*")\
| eval mitre_category="Persistence"\
| eval mitre_technique="Create Account"\
| eval mitre_technique_id="T1136" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T0000] Console History]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 9-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_command_line="*Get-History*" OR process_command_line="*AppData\\Roaming\\Microsoft\\Windows\\PowerShell\\PSReadline\\ConsoleHost_history.txt*" OR process_command_line="*(Get-PSReadlineOption).HistorySavePath*") \
| eval mitre_category="Collection"\
| eval mitre_technique="Console History"\
| eval mitre_technique_id="T0000" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1140] Deobfuscate/Decode Files or Information]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 10-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="certutil.exe" AND process_command_line="*decode*")\
| eval mitre_category="Defense_Evasion"\
| eval mitre_technique="Deobfuscate/Decode Files or Information"\
| eval mitre_technique_id="T1140" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1027] Obfuscated Files or Information]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 11-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="certutil.exe" AND process_command_line="*encode*") OR process_command_line="*ToBase64String*"\
| eval mitre_category="Defense_Evasion"\
| eval mitre_technique="Obfuscated Files or Information"\
| eval mitre_technique_id="T1027" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1146] Clear Command History]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 12-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_command_line="*rm (Get-PSReadlineOption).HistorySavePath*" OR process_command_line="*del (Get-PSReadlineOption).HistorySavePath*" OR process_command_line="*Set-PSReadlineOption –HistorySaveStyle SaveNothing*" OR process_command_line="*Remove-Item (Get-PSReadlineOption).HistorySavePath*") \
| eval mitre_category="Collection"\
| eval mitre_technique="Console History"\
| eval mitre_technique_id="T1146" \
| eval hash_sha256= lower(hash_sha256) \
| `process_create_whitelist` \
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1158] Hidden Files and Directories]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 13-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) process_name="attrib.exe" AND ( process_command_line="*+h*" OR process_command_line="*+s*")\
| eval mitre_category="Persistence,Defense_Evasion"\
| eval mitre_technique="Hidden_Files_and_Directories"\
| eval mitre_technique_id="T1158" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1179] Hooking]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 13-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) process_name="mavinject.exe" OR process_command_line="*/INJECTRUNNING*" \
| eval mitre_category="Persistence,Privilege_Escalation,Credential_Access"\
| eval mitre_technique="Hooking"\
| eval mitre_technique_id="T1179" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1183] Image File Execution Options Injection]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 14-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` (event_id=12 OR event_id=13 OR event_id=14) (registry_key_path="*\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\*" OR registry_key_path="*\\Wow6432Node\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\*")\
| eval mitre_category="Persistence,Privilege_Escalation"\
| eval mitre_technique="Image File Execution Options Injection"\
| eval mitre_technique_id="T1183" \
| `registry_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description event_type host_fqdn process_path  process_id process_guid registry_key_path registry_key_details mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1197] BITS Jobs - Process]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 0-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="bitsadmin.exe" OR process_command_line="*Start-BitsTransfer*") \
| eval mitre_category="Persistence,Defense_Evasion"\
| eval mitre_technique="BITS Jobs"\
| eval mitre_technique_id="T1197" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1202] Indirect Command Execution]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 1-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_parent_name="pcalua.exe" OR process_name="pcalua.exe" OR process_name="bash.exe" OR process_name="forfiles.exe")\
| eval mitre_category="Discovery"\
| eval mitre_technique="Indirect Command Execution"\
| eval mitre_technique_id="T1202" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1217] Browser Bookmark Discovery]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 2-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_command_line="*firefox*places.sqlite*") \
| eval mitre_category="Discovery"\
| eval mitre_technique="Browser Bookmark Discovery"\
| eval mitre_technique_id="T1217" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_gui mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`d

[[T1223] Compiled HTML File]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 3-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) process_name="hh.exe"\
| eval mitre_category="Defense_Evasion,Execution"\
| eval mitre_technique="Compiled HTML File"\
| eval mitre_technique_id="T1223" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1028] Windows Remote Management]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 4-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="wsmprovhost.exe" OR process_name="winrm.cmd" OR process_command_line="*Enable-PSRemoting -Force*" OR process_command_line="*Invoke-Command -computer_name*" process_command_line="wmic*node*process call create*")\
| eval mitre_category="Lateral_Movement,Execution"\
| eval mitre_technique="Windows Remote Management"\
| eval mitre_technique_id="T1028" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1037] Logon Scripts]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 5-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_command_line="*REG*ADD*HKCU\\Environment*UserInitMprLogonScript*")\
| eval mitre_category="Lateral_Movement,Persistence"\
| eval mitre_technique="Logon Scripts"\
| eval mitre_technique_id="T1037" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1040] Network Sniffing]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 6-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="tshark.exe" OR process_name="windump.exe" OR process_name="logman.exe" OR process_name="tcpdump.exe" OR process_name="wprui.exe" OR process_name="wpr.exe")\
| eval mitre_category="Credential_Access,Discovery"\
| eval mitre_technique="Network Sniffing"\
| eval mitre_technique_id="T1040" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1031] Modify Existing Service]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 7-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="sc.exe" OR process_name="powershell.exe" OR process_name="cmd.exe") AND (process_command_line="*sc*config*binpath*")\
| eval mitre_category="Persistence"\
| eval mitre_technique="Modify Existing Service"\
| eval mitre_technique_id="T1031" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1050] New Service - Process]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 8-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="sc.exe" OR process_name="powershell.exe" OR process_name="cmd.exe") AND (process_command_line="*New-Service*BinaryPathName*" OR process_command_line="*sc*create*binpath*" OR process_command_line="*Get-WmiObject*Win32_Service*create*")\
| eval mitre_category="Persistence,Privilege_Escalation,Execution"\
| eval mitre_technique="New Service"\
| eval mitre_technique_id="T1050" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1055] Process Injection]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 9-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` event_id=8 (StartFunction="*LoadLibrary*") \
| eval mitre_category="Privilege_Escalation,Defense_Evasion"\
| eval mitre_technique="Process Injection"\
| eval mitre_technique_id = "T1055"\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description host_fqdn process_name target_process_path target_process_address thread_new_id process_guid process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1055] Process Injection - CobaltStrike]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 10-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` event_id=8 target_process_address=0x*0B80\
| eval hunting_trigger="CobaltStrike injection"\
| eval mitre_category="Privilege_Escalation,Defense_Evasion"\
| eval mitre_technique="Process Injection"\
| eval mitre_technique_id = "T1055"\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description host_fqdn process_name target_process_path target_process_address thread_new_id process_guid process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1055] Process Injection - Process]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 11-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) process_command_line="*Invoke-DllInjection*" OR process_command_line="*c:\\windows\sysnative\\*" \
| eval mitre_category="Privilege_Escalation,Defense_Evasion"\
| eval mitre_technique="Process Injection"\
| eval mitre_technique_id="T1055" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1093] Process Hollowing]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 12-59/15 * * * *
description = parent > child mismatch \
thanks to endgame
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="smss.exe" AND process_parent_name!="smss.exe") OR (process_name="csrss.exe" AND (process_parent_name!="smss.exe" AND process_parent_name!="svchost.exe")) OR (process_name="wininit.exe" AND process_parent_name!="smss.exe") OR (process_name="winlogon.exe" AND process_parent_name!="smss.exe") OR (process_name == "lsass.exe" and parent_process_name != "wininit.exe") OR (process_name="LogonUI.exe" AND (process_parent_name!="winlogon.exe" AND process_parent_name!="wininit.exe")) OR (process_name="services.exe" AND process_parent_name!= "wininit.exe") OR (process_name="spoolsv.exe" AND process_parent_name!= "services.exe") OR (process_name="taskhost.exe" AND (process_parent_name!="services.exe" AND process_parent_name!="svchost.exe")) OR (process_name="taskhostw.exe" AND (process_parent_name!="services.exe" AND process_parent_name!="svchost.exe")) OR (process_name="userinit.exe" AND (process_parent_name!="dwm.exe" AND process_parent_name!="winlogon.exe"))  \
| eval hunting_trigger="parent child mismatch"\
| eval mitre_category="Defense_Evasion"\
| eval mitre_technique="Process Hollowing"\
| eval mitre_technique_id="T1093" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1117] Bypassing Application Whitelisting with Regsvr32]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 13-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="regsvr32.exe" OR process_name="rundll32.exe" OR process_name="certutil.exe") OR process_command_line="*scrobj*"\
| eval mitre_category="Defense_Evasion"\
| eval mitre_technique="Bypassing Application Whitelisting with Regsvr32"\
| eval mitre_technique_id="T1117" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1002] Data Compressed]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 14-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="powershell.exe" AND process_command_line="*-Recurse | Compress-Archive*") OR (process_name="rar.exe" AND process_command_line="rar*a*") OR process_name="7z.exe" OR process_name="*zip.exe"\
| eval mitre_category="Exfiltration"\
| eval mitre_technique="Data Compressed"\
| eval mitre_technique_id="T1002" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1042] Change Default File Association]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 0-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` (event_id=12 OR event_id=13 OR event_id=14) (registry_key_path="*\\SOFTWARE\\Classes\\*\\*" OR registry_key_path="*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\GlobalAssocChangedCounter")\
| eval mitre_category="Persistence"\
| eval mitre_technique="Change Default File Association"\
| eval mitre_technique_id="T1042"  | transaction maxspan=1s process_id\
| `registry_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description event_type host_fqdn process_path process_id process_guid registry_key_path registry_key_details mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1180] Screensaver]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 1-59/15 * * * *
description = thanks to Endgame
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` (event_id=12 OR event_id=13 OR event_id=14) (registry_key_path="*\\Control Panel\\Desktop\\SCRNSAVE.EXE") AND (process_parent_name!="explorer.exe" OR process_name!="rundll32.exe" OR process_command_line!="*shell32.dll,Control_RunDLL desk.cpl,ScreenSaver,*")\
| eval mitre_category="Persistence"\
| eval mitre_technique="Screensaver"\
| eval mitre_technique_id="T1180" \
| `registry_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description event_type host_fqdn process_path  process_id process_guid registry_key_path registry_key_details mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1088] Bypass User Account Control - Registry]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 2-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` (event_id=12 OR event_id=13 OR event_id=14) (registry_key_path="*\\mscfile\\shell\\open\\command\\*" OR registry_key_path="*\\ms-settings\\shell\\open\\command\\*") AND (user_sid!="S-1-5-18" OR user_sid!="S-1-5-19" OR user_sid!="S-1-5-20")\
| eval mitre_category="Privilege_Escalation,Defense_Evasion"\
| eval mitre_technique="Bypass User Account Control"\
| eval mitre_technique_id="T1088" \
| `registry_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description event_type host_fqdn process_path  process_id process_guid registry_key_path registry_key_details mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1086] PowerShell Base64 block used]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 3-59/15 * * * *
description = Powershell Logging
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_view = search
search = | multisearch \
    [ search `indextime` `powershell` (event_id=400 OR event_id=500) \
    | eval MessageA=split(Message,"Details:") \
    | eval Short_Message=mvindex(MessageA,1) \
    | eval MessageA=split(Short_Message,"HostVersion=") \
    | eval MessageA=mvindex(MessageA,1) \
    | eval MessageB=split(MessageA,"HostId=") \
    | eval PS_Version=mvindex(MessageB,0) \
    | eval MessageC=mvindex(MessageB,1) \
    | eval MessageD=split(MessageC,"HostApplication=") \
    | eval Host_ID=mvindex(MessageD,0) \
    | eval MessageE=mvindex(MessageD,1) \
    | eval MessageF=split(MessageE,"EngineVersion=") \
    | eval Host_Application=mvindex(MessageF,0) \
    | eval MessageG=mvindex(MessageF,1) \
    | eval MessageH=split(MessageG,"RunspaceId=") \
    | eval Engine_Version=mvindex(MessageH,0) \
    | eval MessageJ=mvindex(MessageH,1) \
    | eval MessageP=split(MessageJ,"process_command_line=") \
    | eval Command_Line=mvindex(MessageP,1) \
    | rex field=Host_Application "(?<Base64_Data>.[a-zA-Z0-9]{25,1000}+={1})" \
    | fields _time host_fqdn, host, PS_Version, Engine_Version, Host_Application, base64_data, Command_Line | rename Command_Line as process_command_line, HostName as host_fqdn, Host_Application as process_path\
    | where NOT isnull(base64_data)]  \
    [ search `indextime` `windows-security` (event_id=4688) \
    | rex field=Process_Command_Line "(?<base64_data>.[a-zA-Z0-9]{25,1000}+={1})" \
    | fields _time host base64_data, Process_Command_Line | rename Process_Command_Line as process_command_line, HostName as host_fqdn\
    | where NOT isnull(base64_data)] \
    [ search `indextime` `sysmon` (event_id=1) process_name="powershell.exe" \
    | rex field=process_command_line "(?<base64_data>.[a-zA-Z0-9//+]{25,1000}+={1})" \
    | fields _time host_fqdn base64_data, process_command_line, process_path, user_name \
    | where NOT isnull(base64_data)] \
| eval hunting_trigger="Base64 block used"\
| eval mitre_category="Execution"\
| eval mitre_technique="PowerShell"\
| eval mitre_technique_id = "T1086"\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime, host_fqdn, base64_data, PS_Version, Engine_Version, Host_Application, process_command_line, process_path, user_name mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T0000] Suspicious filename used]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 4-59/15 * * * *
description = Suspicious filename
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name=a.exe OR process_name=b.exe OR process_name=c.exe OR process_name=d.exe OR process_name=e.exe OR process_name=f.exe OR process_name=g.exe OR process_name=h.exe OR process_name=i.exe OR process_name=j.exe OR process_name=k.exe OR process_name=l.exe OR process_name=m.exe OR process_name=n.exe OR process_name=o.exe OR process_name=p.exe OR process_name=q.exe OR process_name=r.exe OR process_name=s.exe OR process_name=t.exe OR process_name=u.exe OR process_name=v.exe OR process_name=w.exe OR process_name=x.exe OR process_name=y.exe OR process_name=z.exe OR process_name=1.exe OR process_name=2.exe OR process_name=3.exe OR process_name=4.exe OR process_name=5.exe OR process_name=6.exe OR process_name=7.exe OR process_name=8.exe OR process_name=9.exe OR process_name=0.exe OR process_name=10.exe) \
| eval hunting_trigger="single character filename"\
| eval mitre_category="Execution"\
| eval mitre_technique="Suspicious filename"\
| eval mitre_technique_id="T0000" \
| eval hash_sha256= lower(hash_sha256) \
| `process_create_whitelist` \
| eval indextime = _indextime \
| convert ctime(indextime) \
| table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid file_description mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T0000] Named Pipes - CobaltStrike]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 5-59/15 * * * *
description = default CobaltStrike pipe name
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_view = search
search = `indextime` `sysmon` event_id=17 pipe_name="*msagent_*" \
| eval hunting_trigger="default CobaltStrike pipe name"\
| eval mitre_category="Lateral_Movement"\
| eval mitre_technique="Named Pipes"\
| eval mitre_technique_id="T0000" \
| `pipe_whitelist` \
| eval indextime = _indextime \
| convert ctime(indextime) \
| table _time indextime event_description host_fqdn pipe_name process_path process_guid process_id mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T0000] Named Pipes]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 6-59/15 * * * *
description = suspicious or known bad pipe names
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_view = search
search = `indextime` `sysmon` event_id=17 (pipe_name="*isapi_http*" OR pipe_name="*isapi_dg*" OR pipe_name="*isapi_dg2*" OR pipe_name="*isapi_http*" OR pipe_name="*sdlrpc*" OR pipe_name="*aheec*" OR pipe_name="*winsession*" OR pipe_name="*lsassw*" OR pipe_name="*rpchlp_3*" OR pipe_name="*NamePipe_MoreWindows*" OR pipe_name="*pcheap_reuse*" OR pipe_name="*PSEXESVC*" OR pipe_name="*PowerShellISEPipeName_*" OR pipe_name="*csexec*" OR pipe_name="*paexec*" OR pipe_name="*remcom*")  \
| eval hunting_trigger="suspicious or known bad pipe names"\
| eval mitre_category="Lateral_Movement"\
| eval mitre_technique="Named Pipes"\
| eval mitre_technique_id="T1077" \
| `pipe_whitelist` \
| eval indextime = _indextime \
| convert ctime(indextime) \
| table _time indextime event_description host_fqdn pipe_name process_path process_guid process_id mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1033] System Owner/User Discovery - Network]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 7-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` event_id=3 (dest_port=389 OR dest_port=636 OR dest_port=445 OR dest_port=8080) \
| transaction process_guid maxspan=600s \
| eval target_hosts=mvcount(dest_ip) \
| where target_hosts>5 \
| eval mitre_category="Discovery"\
| eval mitre_technique="System Owner/User Discovery"\
| eval hunting_trigger="connections to multiple systems, possibly blood/sharphound"\
| eval mitre_technique_id="T1069" \
| `network_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description host_fqdn user_name process_path process_id process_parent_id process_command_line process_guid src_ip dst_ip dst_port src_host_name dst_host_name mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1044] File System Permissions Weakness]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 8-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` event_id=7 (driver_loaded="*\\Temp\\*" OR driver_loaded="C:\\Users\\*" OR driver_signature_status!="Valid") \
    | eval hunting_trigger="Drivers from Temp or Unsigned"\
    | eval mitre_category="Persistence,Privilege_Escalation"\
    | eval mitre_technique="File System Permissions Weakness"\
    | eval mitre_technique_id="T1044" \
    | `image_load_whitelist`\
    | eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description host_fqdn process_path driver_loaded driver_is_signed driver_signature driver_signature_status process_id process_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1036] Masquerading - Extension]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 9-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="*.doc.*" OR process_name="*.docx.*" OR process_name="*.xls.*" OR process_name="*.xlsx.*" OR process_name="*.pdf.*" OR process_name="*.rtf.*" OR process_name="*.jpg.*" OR process_name="*.png.*" OR process_name="*.jpeg.*"  OR process_name="*.zip.*" OR process_name="*.rar.*"  OR process_name="*.ppt.*" OR process_name="*.pptx.*")\
| eval mitre_category="Defense_Evasion"\
| eval mitre_technique="Masquerading"\
| eval hunting_trigger="Malware masquarading as a document"\
| eval mitre_technique_id="T1036" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1158] Hidden Files and Directories - VSS]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 10-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_path="*\\VolumeShadowCopy*\\*" OR process_commandline="*\\VolumeShadowCopy*\\*")\
| eval mitre_category="Defense_Evasion,Persistence"\
| eval mitre_technique="Hidden Files and Directories"\
| eval hunting_trigger="VolumeShadowCopy execution"\
| eval mitre_technique_id="T1158" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1036] Masquerading - Location]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 11-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` event_id=11 (file_path="*SysWOW64*" OR file_path="*System32*" OR file_path="*AppData*") AND (file_name="*.exe" OR file_name="*.dll" OR file_name="*.bat" OR file_name="*.com" OR file_name="*.ps1" OR file_name="*.py" OR file_name="*.js" OR file_name="*.vbs" OR file_name="*.hta") \
| eval mitre_category="Defense_Evasion"\
| eval mitre_technique="Masquerading"\
| eval hunting_trigger="Executable file write in trusted location"\
| eval mitre_technique_id="T1036" \
| `file_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description host_fqdn process_path process_guid process_id file_name file_path mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1193] Spearphishing Attachment]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 12-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` event_id=11 (file_name="*.docm" OR file_name="*.xlsm" OR file_name="*.pptm" OR file_name="*.ps1" OR file_name="*.py" OR file_name="*.js" OR file_name="*.vbs" OR file_name="*.hta" OR file_name="*.bat" OR file_name="*.slk" OR file_name="*.jspx" OR file_name="*.cmd" OR file_name="*.php" OR file_name="*.pyw" OR file_name="*.xla" OR file_name="*.application" OR file_name="*.potm" OR file_name="*.csproj" OR file_name="*.aspx" OR file_name="*.exe") \
| eval mitre_category="Initial_Access"\
| eval mitre_technique="Spearphishing Attachment"\
| eval hunting_trigger="Potentially malicious file saved"\
| eval mitre_technique_id="T1193" \
| `file_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description host_fqdn process_path process_guid process_id file_name file_path mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1060] Registry Run Keys or Start Folder - Folder Changed]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 13-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` event_id=13 registry_key_path="HKU\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders\\Startup" AND registry_key_details!="*\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup"  \
| eval mitre_category="Persistence"\
| eval mitre_technique="Registry Run Keys or Start Folder"\
| eval hunting_trigger="User start folder changed"\
| eval mitre_technique_id="T1060" \
| `registry_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description event_type host_fqdn process_path process_id process_guid registry_key_path registry_key_details mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1193] Spearphishing Attachment - Opened]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 14-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` event_id=13 registry_key_path="*trustrecords*" OR registry_key_path="*TargetObject=*Software\\Microsoft\\VBA\\7.1\\Common*" \
| eval mitre_category="Initial_Access"\
| eval mitre_technique="Spearphishing Attachment"\
| eval hunting_trigger="Macro enabled for document"\
| eval mitre_technique_id="T1193" \
| `registry_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description event_type host_fqdn process_path process_id process_guid registry_key_path registry_key_details mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1093] Process Hollowing - commandline]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 0-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_command_line="" OR process_command_line=$$process_path$$)\
| eval mitre_category="Defense_Evasion"\
| eval mitre_technique="Process Hollowing"\
| eval hunting_trigger="possible hollowed process"\
| eval mitre_technique_id="T1093" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1127] Trusted Developer Utilities - net2]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 1-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
search = `indextime` `sysmon` event_id=11 target_file_name="*\\AppData\\Local\\Microsoft\\CLR_v2.0*\\UsageLogs\\*"\
| eval hunting_trigger=".Net 2.0 compatible execution, probably bad"\
| eval mitre_category="Defense_Evasion,Execution"\
| eval mitre_technique="Trusted Developer Utilities"\
| eval mitre_technique_id="T1127" \
| `file_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description host_fqdn process_path file_path process_guid process_id mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1093] Process Hollowing - office commandline]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 2-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_parent_name="winword.exe" OR process_parent_name="excel.exe" OR process_parent_name="outlook.exe") process_command_line="C:\\Program Files\\Microsoft Office\\*-enc*"\
| eval mitre_category="Defense_Evasion"\
| eval mitre_technique="Process Hollowing"\
| eval hunting_trigger="possible hollowed process"\
| eval mitre_technique_id="T1093" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1073] DLL Side-Loading - PowerShell]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 3-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` event_id=7 (driver_loaded="*\\System.Management.Automation.ni.dll" OR driver_loaded="*\\System.Management.Automation.dll" OR driver_loaded="*\\PowerShdll.dll") (process_name!="powershell.exe" OR process_name!="powershell_ise.exe")\
    | eval hunting_trigger="Possibly non-legit PowerShell"\
    | eval mitre_category="Defense_Evasion"\
    | eval mitre_technique="DLL Side-Loading"\
    | eval mitre_technique_id="T1073" \
    | `image_load_whitelist`\
    | eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description host_fqdn process_path driver_loaded driver_is_signed driver_signature driver_signature_status process_id process_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1073] DLL Side-Loading - WMI]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 4-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` event_id=7 (driver_loaded="wmiutils.dll") (process_path!="C:\\Windows\\*")\
    | eval hunting_trigger="Possibly non-legit WMI use"\
    | eval mitre_category="Defense_Evasion"\
    | eval mitre_technique="DLL Side-Loading"\
    | eval mitre_technique_id="T1073" \
    | `image_load_whitelist`\
    | eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description host_fqdn process_path driver_loaded driver_is_signed driver_signature driver_signature_status process_id process_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1040] Network Sniffing - Process]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 5-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) ((process_name="netsh.exe" AND process_command_line="*trace*start*capture=yes*") OR process_name="tshark.exe" OR process_name="wireshark.exe")\
| eval mitre_category="Credential_Access,Discovery"\
| eval mitre_technique="Network Sniffing"\
| eval mitre_technique_id="T1128" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1036] Masquerading - svchost]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 6-59/15 * * * *
description = parent > child mismatch \
thanks to endgame
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="svchost.exe" AND process_parent_name!="services.exe") OR process_name="scvhost.exe" \
| eval hunting_trigger="parent child mismatch"\
| eval mitre_category="Defense_Evasion"\
| eval mitre_technique="Masquerading"\
| eval mitre_technique_id="T1036" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1036] Masquerading - explorer]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 7-59/15 * * * *
description = parent > child mismatch \
thanks to endgame
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="explorer.exe" AND process_parent_name!="userinit.exe") \
| eval hunting_trigger="parent child mismatch"\
| eval mitre_category="Defense_Evasion"\
| eval mitre_technique="Masquerading"\
| eval mitre_technique_id="T1036" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1036] Masquerading - renamedbin]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 8-59/15 * * * *
description = parent > child mismatch \
thanks to endgame
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` `sysmon` event_id=1 | eval process_name=lower(process_name) | eval original_file_name=lower(original_file_name) | where process_name!=original_file_name  \
| eval hunting_trigger="Renamed binary"\
| eval mitre_category="Defense_Evasion"\
| eval mitre_technique="Masquerading"\
| eval mitre_technique_id="T1036" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1002] Data Compressed - Files]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 9-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
search = `indextime` `sysmon` event_id=11 (file_name="*.zip" OR file_name="*.rar" OR file_name="*.arj" OR file_name="*.gz" OR file_name="*.tar" OR file_name="*.tgz" OR file_name="*.7z" OR file_name="*.zip" OR file_name="*.tar.gz" OR file_name="*.bin") \
| eval mitre_category="Exfiltration"\
| eval mitre_technique="Data Compressed"\
| eval mitre_technique_id="T1002" \
| `file_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description host_fqdn process_path process_guid process_id file_name file_path mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1071] Standard Application Layer Protocol]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 10-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
search = `indextime` `sysmon` event_id=22 [| inptlookup doh.csv] \
| eval mitre_category="Command_and_Control"\
| eval mitre_technique="Standard Application Layer Protocol"\
| eval hunting_trigger="DNS over HTTPS used" \
| eval mitre_technique_id="T1071" \
| eval event_description="DNS Query"  | `dns_whitelist` | table _time indextime event_description host_fqdn process_path query_name query_status query_results process_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`

[[T1040] Network Sniffing - Packet Capture Tools]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 11-59/15 * * * *
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
request.ui_dispatch_app = ThreatHunting
request.ui_dispatch_view = search
search = `indextime` ((`sysmon` event_id=1) OR (`windows-security` event_id=4688)) (process_name="pktmon.exe" OR process_name="tcpdump.exe") OR (original_file_name="pktmon.exe" OR original_file_name="tcpdump.exe") OR (process_name="netsh.exe" AND process_command_line="*trace start capture=yes*")\
| eval hunting_trigger="packet capture tool"\
| eval mitre_category="Discovery,Credential_Access"\
| eval mitre_technique="Masquerading"\
| eval mitre_technique_id="T1040" \
| eval hash_sha256= lower(hash_sha256)\
| `process_create_whitelist`\
| eval indextime = _indextime | convert ctime(indextime) | table _time indextime event_description hash_sha256 host_fqdn user_name original_file_name process_path process_guid process_parent_path process_id process_parent_id process_command_line process_parent_command_line process_parent_guid mitre_category mitre_technique mitre_technique_id hunting_trigger\
| collect `threathunting_index`